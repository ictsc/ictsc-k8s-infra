apiVersion: v1
kind: Namespace
metadata:
  name: gateway
---
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: gateway-web-proxy
  namespace: gateway
spec:
  description: Allow internet access to web Gateway Proxies in the gateway namespace
  endpointSelector:
    matchLabels:
      app.kubernetes.io/component: proxy
      gateway.envoyproxy.io/owning-gateway-name: web
      gateway.envoyproxy.io/owning-gateway-namespace: gateway
      k8s:io.kubernetes.pod.namespace: envoy-gateway-system
  ingress:
  - fromEntities:
    - all
    toPorts:
    - ports:
      - port: "10080"
        protocol: TCP
      - port: "10443"
        protocol: ANY
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: web
  namespace: gateway
spec:
  bootstrap:
    jsonPatches:
    - op: replace
      path: /admin/address/socket_address/address
      value: '::'
    - op: add
      path: /admin/address/socket_address/ipv4_compat
      value: true
    type: JSONPatch
  ipFamily: IPv6
  provider:
    kubernetes:
      envoyDeployment:
        replicas: 1
      envoyService:
        annotations:
          lbipam.cilium.io/ips: 2001:e42:407:103c:1::80,64:ff9b::163.43.176.221
          service.cilium.io/forwarding-mode: dsr
        externalTrafficPolicy: Cluster
        labels:
          k8s.ictsc.net/lb-ipv4: "true"
    type: Kubernetes
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: web
  namespace: gateway
spec:
  gatewayClassName: envoy-gateway
  infrastructure:
    parametersRef:
      group: gateway.envoyproxy.io
      kind: EnvoyProxy
      name: web
  listeners:
  - allowedRoutes:
      namespaces:
        from: All
    name: http
    port: 80
    protocol: HTTP
